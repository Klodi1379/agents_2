{% extends 'base.html' %}

{% block title %}Analytics & Insights - AI Company{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active">Analytics</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="refreshAnalytics()">
        <i class="fas fa-sync-alt"></i> Refresh Data
    </button>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-download"></i> Export
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportAnalytics('pdf')">
                <i class="fas fa-file-pdf"></i> Export as PDF
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportAnalytics('excel')">
                <i class="fas fa-file-excel"></i> Export as Excel
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportAnalytics('csv')">
                <i class="fas fa-file-csv"></i> Export as CSV
            </a></li>
        </ul>
    </div>
    <button type="button" class="btn btn-outline-info" onclick="scheduleReport()">
        <i class="fas fa-clock"></i> Schedule Report
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Analytics Header -->
<div class="analytics-header mb-4">
    <div class="row">
        <div class="col-md-8">
            <h2 class="mb-2">Your Business Analysis Insights</h2>
            <p class="text-muted">Comprehensive analytics and performance metrics for your business ideas</p>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <div class="h4 text-info mb-1">{{ total_ideas }}</div>
                    <div class="small text-muted">Total Ideas Analyzed</div>
                    <div class="small text-success">
                        <i class="fas fa-arrow-up"></i> {{ completed_ideas }} Completed
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Period Selector -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-0">Time Period Analysis</h6>
                <small class="text-muted">Select a time range to analyze your data</small>
            </div>
            <div class="col-md-6">
                <div class="btn-group w-100" role="group" id="timePeriodSelector">
                    <input type="radio" class="btn-check" name="timePeriod" id="period7d" value="7d">
                    <label class="btn btn-outline-primary" for="period7d">7 Days</label>
                    
                    <input type="radio" class="btn-check" name="timePeriod" id="period30d" value="30d">
                    <label class="btn btn-outline-primary" for="period30d">30 Days</label>
                    
                    <input type="radio" class="btn-check" name="timePeriod" id="period90d" value="90d">
                    <label class="btn btn-outline-primary" for="period90d">90 Days</label>
                    
                    <input type="radio" class="btn-check" name="timePeriod" id="period6m" value="6m" checked>
                    <label class="btn btn-outline-primary" for="period6m">6 Months</label>
                    
                    <input type="radio" class="btn-check" name="timePeriod" id="period1y" value="1y">
                    <label class="btn btn-outline-primary" for="period1y">1 Year</label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card kpi-card border-start border-primary border-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="kpi-label text-muted small">Average Score</div>
                        <div class="kpi-value h3 text-primary mb-0" id="avgScore">
                            {% if monthly_data %}{{ monthly_data|last.average_score }}{% else %}--{% endif %}
                        </div>
                        <div class="kpi-change small text-success">
                            <i class="fas fa-arrow-up"></i> +5.2% vs last period
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-star fa-2x text-primary opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card kpi-card border-start border-success border-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="kpi-label text-muted small">Success Rate</div>
                        <div class="kpi-value h3 text-success mb-0" id="successRate">
                            {% if completed_ideas and total_ideas %}{{ completed_ideas|div:total_ideas|mul:100|floatformat:1 }}%{% else %}--{% endif %}
                        </div>
                        <div class="kpi-change small text-success">
                            <i class="fas fa-arrow-up"></i> +12.8% vs last period
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-check-circle fa-2x text-success opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card kpi-card border-start border-warning border-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="kpi-label text-muted small">Avg Analysis Time</div>
                        <div class="kpi-value h3 text-warning mb-0" id="avgTime">8.2m</div>
                        <div class="kpi-change small text-success">
                            <i class="fas fa-arrow-down"></i> -2.1m vs last period
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-clock fa-2x text-warning opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card kpi-card border-start border-info border-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="kpi-label text-muted small">Ideas This Month</div>
                        <div class="kpi-value h3 text-info mb-0" id="monthlyIdeas">
                            {% if monthly_data %}{{ monthly_data|last.ideas_submitted }}{% else %}--{% endif %}
                        </div>
                        <div class="kpi-change small text-success">
                            <i class="fas fa-arrow-up"></i> +25% vs last month
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-lightbulb fa-2x text-info opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Submission Trends -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Submission & Performance Trends</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="trendChart" id="submissions" checked>
                    <label class="btn btn-outline-primary" for="submissions">Submissions</label>
                    
                    <input type="radio" class="btn-check" name="trendChart" id="scores">
                    <label class="btn btn-outline-primary" for="scores">Scores</label>
                    
                    <input type="radio" class="btn-check" name="trendChart" id="combined">
                    <label class="btn btn-outline-primary" for="combined">Combined</label>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 350px;">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Industry Performance -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Industry Performance</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="industryChart"></canvas>
                </div>
                <div class="industry-legend mt-3">
                    {% for industry in industry_performance %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="legend-color me-2" style="width: 12px; height: 12px; border-radius: 50%; background: var(--industry-color-{{ forloop.counter }});"></div>
                            <small>{{ industry.industry|capfirst }}</small>
                        </div>
                        <div class="text-end">
                            <div class="small fw-bold">{{ industry.avg_score|floatformat:1 }}</div>
                            <div class="small text-muted">{{ industry.count }} ideas</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Analysis Row -->
<div class="row mb-4">
    <!-- Top Performing Ideas -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-trophy"></i> Top Performing Ideas</h5>
                <a href="{% url 'dashboard:ideas_list' %}?order_by=-overall_score" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="card-body">
                {% if top_ideas %}
                <div class="top-ideas-list">
                    {% for idea in top_ideas %}
                    <div class="top-idea-item d-flex align-items-center mb-3" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|mul:100 }}">
                        <div class="rank-badge me-3">
                            <div class="rank-number">#{{ forloop.counter }}</div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <a href="{% url 'dashboard:idea_detail' idea.id %}" class="text-decoration-none">
                                    {{ idea.title|truncatechars:40 }}
                                </a>
                            </h6>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">{{ idea.get_industry_display }}</span>
                                <small class="text-muted">{{ idea.submitted_at|date:"M d, Y" }}</small>
                            </div>
                        </div>
                        <div class="score-display text-end">
                            <div class="score-circle score-{{ idea.overall_score|div:20|floatformat:0 }}">
                                {{ idea.overall_score }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h6>No completed analyses yet</h6>
                    <p class="text-muted small">Submit more ideas to see performance rankings</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Agent Performance -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users-cog"></i> AI Agent Performance</h5>
            </div>
            <div class="card-body">
                {% if agent_performance %}
                <div class="agent-performance-list">
                    {% for agent in agent_performance %}
                    <div class="agent-performance-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <div class="agent-avatar me-3">
                                    {% if agent.agent_type == 'CEO' %}
                                        <i class="fas fa-crown"></i>
                                    {% elif agent.agent_type == 'MARKET_RESEARCH' %}
                                        <i class="fas fa-chart-bar"></i>
                                    {% elif agent.agent_type == 'FINANCIAL_ANALYST' %}
                                        <i class="fas fa-calculator"></i>
                                    {% elif agent.agent_type == 'TECHNICAL_LEAD' %}
                                        <i class="fas fa-code"></i>
                                    {% elif agent.agent_type == 'RISK_ANALYST' %}
                                        <i class="fas fa-shield-alt"></i>
                                    {% elif agent.agent_type == 'MARKETING_STRATEGIST' %}
                                        <i class="fas fa-bullhorn"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ agent.agent_type|capfirst|replace:"_":" " }}</h6>
                                    <small class="text-muted">{{ agent.count }} analyses</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary">{{ agent.avg_score|floatformat:1 }}</div>
                                <small class="text-muted">Avg Score</small>
                            </div>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar 
                                {% if agent.avg_score >= 80 %}bg-success
                                {% elif agent.avg_score >= 60 %}bg-warning
                                {% else %}bg-danger{% endif %}" 
                                style="width: {{ agent.avg_score }}%">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Confidence: {{ agent.avg_confidence|floatformat:1 }}%</small>
                            <small class="text-muted">{{ agent.avg_score|floatformat:1 }}/100</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users-cog fa-3x text-muted mb-3"></i>
                    <h6>No agent data yet</h6>
                    <p class="text-muted small">Complete more analyses to see agent performance</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Insights and Recommendations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb"></i> AI-Generated Insights & Recommendations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="insight-card bg-primary text-white rounded p-3 mb-3">
                            <div class="insight-icon mb-2">
                                <i class="fas fa-trending-up fa-2x"></i>
                            </div>
                            <h6>Performance Trend</h6>
                            <p class="small mb-0">Your ideas have shown a 15% improvement in average scores over the past 3 months. Keep focusing on market research!</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="insight-card bg-success text-white rounded p-3 mb-3">
                            <div class="insight-icon mb-2">
                                <i class="fas fa-industry fa-2x"></i>
                            </div>
                            <h6>Best Industry</h6>
                            <p class="small mb-0">Your technology sector ideas score 23% higher than average. Consider focusing more on tech innovations.</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="insight-card bg-info text-white rounded p-3 mb-3">
                            <div class="insight-icon mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h6>Optimal Timing</h6>
                            <p class="small mb-0">Ideas submitted on Tuesday-Thursday receive more detailed analysis. Plan your submissions accordingly.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Items -->
                <div class="action-items mt-4 pt-4 border-top">
                    <h6 class="mb-3">Recommended Actions</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="action-item d-flex align-items-start mb-3">
                                <div class="action-icon me-3">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Improve Market Research</h6>
                                    <p class="text-muted small mb-0">Add more specific target market details to boost your scores by an estimated 12%</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="action-item d-flex align-items-start mb-3">
                                <div class="action-icon me-3">
                                    <i class="fas fa-chart-line text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">Focus on Financial Planning</h6>
                                    <p class="text-muted small mb-0">Include revenue models and cost structures for higher financial scores</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Analytics Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" id="reportType">
                            <option value="summary">Executive Summary</option>
                            <option value="detailed">Detailed Analytics</option>
                            <option value="performance">Performance Report</option>
                            <option value="trends">Trends Analysis</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Time Period</label>
                        <select class="form-select" id="exportTimePeriod">
                            <option value="30d">Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="6m" selected>Last 6 Months</option>
                            <option value="1y">Last Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">
                                Include Charts and Visualizations
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmExport()">
                    <i class="fas fa-download"></i> Generate Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_css %}
<style>
:root {
    --industry-color-1: #3498db;
    --industry-color-2: #e74c3c;
    --industry-color-3: #2ecc71;
    --industry-color-4: #f39c12;
    --industry-color-5: #9b59b6;
    --industry-color-6: #1abc9c;
    --industry-color-7: #34495e;
}

.analytics-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.kpi-card {
    transition: all 0.3s ease;
    border: none;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.kpi-value {
    font-weight: 700;
    line-height: 1;
}

.kpi-label {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.kpi-change {
    font-weight: 500;
}

.kpi-icon {
    width: 60px;
    text-align: center;
}

.chart-container {
    background: #fafafa;
    border-radius: 8px;
    padding: 1rem;
}

.top-idea-item {
    padding: 1rem;
    border-radius: 10px;
    background: #f8f9fa;
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
}

.top-idea-item:hover {
    background: white;
    border-left-color: #3498db;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(45deg, #3498db, #2980b9);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
}

.rank-number {
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.score-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
}

.score-5 { background: linear-gradient(45deg, #27ae60, #2ecc71); }
.score-4 { background: linear-gradient(45deg, #f39c12, #e67e22); }
.score-3 { background: linear-gradient(45deg, #e74c3c, #c0392b); }
.score-2 { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
.score-1 { background: linear-gradient(45deg, #34495e, #2c3e50); }

.agent-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3498db, #2980b9);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
}

.agent-performance-item {
    padding: 1rem;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.agent-performance-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.insight-card {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.insight-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    transition: all 0.3s ease;
}

.insight-card:hover::before {
    top: -25%;
    right: -25%;
}

.insight-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.insight-icon {
    opacity: 0.8;
}

.action-item {
    padding: 1rem;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.action-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateX(5px);
}

.action-icon {
    width: 30px;
    text-align: center;
}

.legend-color {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-group .btn-check:checked + .btn {
    background: linear-gradient(45deg, #3498db, #2980b9);
    border-color: #3498db;
}

.fade-in-up {
    animation: fadeInUp 0.6s ease forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.loading-chart {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    background: #f8f9fa;
    border-radius: 8px;
}

.export-progress {
    display: none;
    text-align: center;
    padding: 2rem;
}

.export-progress .progress {
    height: 8px;
    border-radius: 4px;
    margin: 1rem 0;
}

@media (max-width: 768px) {
    .analytics-header {
        padding: 1.5rem;
        text-align: center;
    }
    
    .chart-container {
        height: 250px !important;
    }
    
    .kpi-card {
        margin-bottom: 1rem;
    }
    
    .insight-card {
        margin-bottom: 1rem;
    }
    
    .btn-group {
        display: flex;
        flex-wrap: wrap;
    }
    
    .btn-group .btn {
        flex: 1;
        min-width: 80px;
    }
}

.time-period-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255,255,255,0.9);
    color: #333;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let trendsChart, industryChart;
let currentTimePeriod = '6m';
let analyticsData = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeAnalytics();
    setupEventListeners();
    loadAnalyticsData();
});

function initializeAnalytics() {
    // Initialize charts
    createTrendsChart();
    createIndustryChart();
    
    // Setup animations
    animateKPIs();
    animateCards();
}

function setupEventListeners() {
    // Time period selector
    document.querySelectorAll('input[name="timePeriod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentTimePeriod = this.value;
            updateAnalyticsData();
        });
    });
    
    // Chart type selector
    document.querySelectorAll('input[name="trendChart"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateTrendsChart(this.value);
        });
    });
}

function loadAnalyticsData() {
    // Load data from Django context
    analyticsData = {
        monthly: {{ monthly_data|safe }},
        industry: {{ industry_performance|safe }},
        topIdeas: {{ top_ideas|length }},
        agentPerformance: {{ agent_performance|safe }}
    };
    
    updateCharts();
}

function createTrendsChart() {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    const monthlyData = {{ monthly_data|safe }};
    const labels = monthlyData.map(item => item.month);
    const submissionsData = monthlyData.map(item => item.ideas_submitted);
    const scoresData = monthlyData.map(item => item.average_score);
    const completedData = monthlyData.map(item => item.analyses_completed);
    
    trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ideas Submitted',
                data: submissionsData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }, {
                label: 'Completed Analyses',
                data: completedData,
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#27ae60',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#3498db',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function createIndustryChart() {
    const ctx = document.getElementById('industryChart').getContext('2d');
    
    const industryData = {{ industry_performance|safe }};
    const labels = industryData.map(item => item.industry);
    const scores = industryData.map(item => item.avg_score);
    const counts = industryData.map(item => item.count);
    
    const colors = [
        'rgba(52, 152, 219, 0.8)',
        'rgba(231, 76, 60, 0.8)',
        'rgba(46, 204, 113, 0.8)',
        'rgba(243, 156, 18, 0.8)',
        'rgba(155, 89, 182, 0.8)',
        'rgba(26, 188, 156, 0.8)',
        'rgba(52, 73, 94, 0.8)'
    ];
    
    industryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: scores,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1')),
                borderWidth: 2,
                hoverBorderWidth: 4,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#3498db',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const industry = context.label;
                            const score = context.parsed;
                            const count = counts[context.dataIndex];
                            return [
                                `${industry}`,
                                `Average Score: ${score.toFixed(1)}`,
                                `Ideas: ${count}`
                            ];
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function updateTrendsChart(type) {
    if (!trendsChart) return;
    
    const monthlyData = {{ monthly_data|safe }};
    
    switch(type) {
        case 'submissions':
            trendsChart.data.datasets = [{
                label: 'Ideas Submitted',
                data: monthlyData.map(item => item.ideas_submitted),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }];
            break;
            
        case 'scores':
            trendsChart.data.datasets = [{
                label: 'Average Score',
                data: monthlyData.map(item => item.average_score),
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }];
            break;
            
        case 'combined':
        default:
            trendsChart.data.datasets = [{
                label: 'Ideas Submitted',
                data: monthlyData.map(item => item.ideas_submitted),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                yAxisID: 'y'
            }, {
                label: 'Average Score',
                data: monthlyData.map(item => item.average_score),
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
            }];
            
            // Add second y-axis for combined view
            trendsChart.options.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                    drawOnChartArea: false,
                },
                ticks: {
                    beginAtZero: true,
                    max: 100
                }
            };
            break;
    }
    
    trendsChart.update('active');
}

function updateCharts() {
    if (trendsChart) {
        trendsChart.update();
    }
    if (industryChart) {
        industryChart.update();
    }
}

function animateKPIs() {
    const kpiValues = document.querySelectorAll('.kpi-value');
    
    kpiValues.forEach((element, index) => {
        const finalValue = element.textContent;
        const isNumber = !isNaN(parseFloat(finalValue));
        
        if (isNumber) {
            const value = parseFloat(finalValue);
            element.textContent = '0';
            
            setTimeout(() => {
                animateValue(element, 0, value, 1500);
            }, index * 200);
        }
    });
}

function animateValue(element, start, end, duration) {
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= end) {
            current = end;
            clearInterval(timer);
        }
        
        if (element.textContent.includes('%')) {
            element.textContent = current.toFixed(1) + '%';
        } else if (element.textContent.includes('m')) {
            element.textContent = current.toFixed(1) + 'm';
        } else {
            element.textContent = Math.round(current);
        }
    }, 16);
}

function animateCards() {
    const cards = document.querySelectorAll('.top-idea-item, .agent-performance-item, .insight-card, .action-item');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.classList.add('fade-in-up');
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    });
    
    cards.forEach(card => {
        observer.observe(card);
    });
}

function refreshAnalytics() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    // Simulate data refresh
    setTimeout(() => {
        // Update KPIs with slight variations
        updateKPIsWithNewData();
        
        // Refresh charts
        updateCharts();
        
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        showAlert('Analytics data refreshed successfully!', 'success');
    }, 2000);
}

function updateKPIsWithNewData() {
    // Simulate real-time updates with slight variations
    const avgScoreElement = document.getElementById('avgScore');
    const successRateElement = document.getElementById('successRate');
    const avgTimeElement = document.getElementById('avgTime');
    const monthlyIdeasElement = document.getElementById('monthlyIdeas');
    
    if (avgScoreElement && avgScoreElement.textContent !== '--') {
        const currentValue = parseFloat(avgScoreElement.textContent);
        const newValue = currentValue + (Math.random() - 0.5) * 2;
        animateValue(avgScoreElement, currentValue, Math.max(0, Math.min(100, newValue)), 1000);
    }
}

function updateAnalyticsData() {
    showLoading('Updating analytics data...');
    
    // Simulate API call to get new data for selected time period
    setTimeout(() => {
        hideLoading();
        updateCharts();
        showAlert(`Data updated for ${currentTimePeriod} period`, 'success');
    }, 1500);
}

function exportAnalytics(format) {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
    
    // Set the format in a hidden field or store it
    document.getElementById('exportModal').setAttribute('data-format', format);
}

function confirmExport() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    const format = document.getElementById('exportModal').getAttribute('data-format');
    const reportType = document.getElementById('reportType').value;
    const timePeriod = document.getElementById('exportTimePeriod').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    modal.hide();
    
    // Show export progress
    showExportProgress(format, reportType);
}

function showExportProgress(format, reportType) {
    const progressHtml = `
        <div class="export-progress" id="exportProgress">
            <h5>Generating ${format.toUpperCase()} Report</h5>
            <p class="text-muted">Preparing your ${reportType} analytics report...</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" id="exportProgressBar"></div>
            </div>
            <div class="small text-muted mt-2" id="exportStatus">Initializing...</div>
        </div>
    `;
    
    showAlert(progressHtml, 'info', 0); // 0 means don't auto-hide
    
    // Simulate export progress
    let progress = 0;
    const progressBar = document.getElementById('exportProgressBar');
    const statusElement = document.getElementById('exportStatus');
    
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        
        if (progress >= 100) {
            progress = 100;
            clearInterval(progressInterval);
            
            statusElement.textContent = 'Export completed!';
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            
            setTimeout(() => {
                document.querySelector('.alert').remove();
                showAlert(`${format.toUpperCase()} report downloaded successfully!`, 'success');
            }, 1000);
        } else {
            progressBar.style.width = progress + '%';
            
            if (progress < 30) {
                statusElement.textContent = 'Collecting data...';
            } else if (progress < 60) {
                statusElement.textContent = 'Generating charts...';
            } else if (progress < 90) {
                statusElement.textContent = 'Formatting report...';
            } else {
                statusElement.textContent = 'Finalizing export...';
            }
        }
    }, 500);
}

function scheduleReport() {
    showAlert('Report scheduling feature coming soon!', 'info');
}

function showLoading(message = 'Loading...') {
    const loadingHtml = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="h6">${message}</div>
        </div>
    `;
    
    // Replace chart containers with loading
    document.querySelectorAll('.chart-container').forEach(container => {
        container.innerHTML = loadingHtml;
    });
}

function hideLoading() {
    // Recreate charts after loading
    setTimeout(() => {
        createTrendsChart();
        createIndustryChart();
    }, 100);
}

function showAlert(message, type = 'info', autoHide = 5000) {
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertElement.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px; max-width: 500px;';
    alertElement.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertElement);
    
    if (autoHide > 0) {
        setTimeout(() => {
            if (alertElement.parentNode) {
                alertElement.classList.remove('show');
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                }, 150);
            }
        }, autoHide);
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (trendsChart) {
        trendsChart.destroy();
    }
    if (industryChart) {
        industryChart.destroy();
    }
});
</script>
{% endblock %}